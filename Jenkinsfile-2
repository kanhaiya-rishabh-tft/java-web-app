pipeline {
  agent { label 'default' }
  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }
  environment {
    DOCKER_HUB_CREDS = credentials('docker-credential')
    AWS_CREDS = credentials('rishabh-admin')
    // KEYCHAIN_PASSWORD = credentials('darinpope-keychain')
    // $DOCKER_HUB_CREDS 
    // $DOCKER_HUB_CREDS_PSW
    // $AWS_ACCESS_KEY_ID
    // $AWS_SECRET_ACCESS_KEY
     AWS_DEFAULT_REGION = 'ap-south-1'
  stages {
    stage('Tooling versions') {
      steps {
        sh '''
          docker --version
          docker-compose version
        '''
      }
    }
    // stage('Unlock keychain') {
    //   steps {
    //     sh 'security -v unlock-keychain -p $KEYCHAIN_PASSWORD ~/Library/Keychains/login.keychain-db'
    //   }
    // }
    stage('Build') {
      steps {
        sh 'docker context use default'
        sh 'docker-compose build'
        //sh 'docker-compose push'
      }
    }
    stage('Deploy') {
      steps {
        sh 'sudo docker context create ecs myecscontext --from-env'
        sh 'sudo docker context use myecscontext'
        sh 'sudo docker-compose up'
        sh 'sudo docker-compose ps --format json'
        sh 'sudo docker context rm myecscontext'
      }
    }
  }
  // post {
  //   always {
  //       sh 'security -v lock-keychain ~/Library/Keychains/login.keychain-db'
  //   }
  // }
}
